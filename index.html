<!DOCTYPE html PUBLIC "-//WC3//DTD XHTML 1.0 Strict//EN"

	http://www.w3.org/TR/xhmtl1/DTS/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">

	<head>
		<title>MEAN Server</title>

		  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

		  <meta name="viewport" content="width=device-width, initial-scale=1">

		  <style>
		  	#viddy {
		  		/* background: pink; */
		  	}
		  	#wally {
		  		cursor: pointer;
		  	}
		  </style>
	</head>
	<body> 
	<div id="viddy">
		<h3>Local Ad of the Day - REMOTE</h3>

		<video id="wally" width="320" height="240" autoplay><source id="thesource" src="" type="video/mp4"></video><br/>
		ID: <span class="id">Time to Chime</span><br/>
		Channel: <span class="channel">channel</span><br/>
		AdId: <span class="adId">adid</span><br/>
		Location: <span class="location">viddy</span><br/>
		Type: <span class="type">type</span><br/>
		Clicks: <span class="clicks">clicks</span>
	</div>

</body>
<script>
 $(document).ready(function () {
 	var viddy;
	var id;
	var adId;
	var channel;
	var type;
	var clicks;

				$.ajax({
				        type: 'GET',
				        //url: 'http://localhost:8081/test?callback=jsonpCallback',
				        //url: 'http://adserver-env-poly.elasticbeanstalk.com/?callback=jsonpCallback',
				        url: 'http://localhost:8081/?callback=jsonpCallback',
				        crossDomain: true,
				        async: false,
				        jsonpCallback: 'jsonpCallback',
				        dataType: 'json',
				        contentType:'application/json',
				        error: function(data){
				        	console.log("error: " , data);
				        },
				        success: function(data) {  

				        	console.log("received new data: " , data ); 

				        	var r = rand(1,3);
				        	console.log("random #:" + r );
				        	console.log("random # viddy:" + data[r].adId );

				        	id = data[r]._id
				        	channels = data[0];
				        	ads = data[1];     
	
					         viddy = data[r].location; //ads.location;
					         adid = data[r].adId;
					         channel = channels.channels[1];
					         type = ads.type;
					         clicks = data[r].views;

					         console.log("Our Viddy: " + channel );

						    $('#thesource').attr('src',viddy );

						    var player = document.getElementById('wally'); 

						    player.load(); 

						$(".id").text(id);
						$(".adId").text(adid);
						$(".channel").text(channel);
						$(".location").text(viddy);
						$(".type").text(type);
						$(".clicks").text(clicks);
				        }
				    });


		 function jsonpCallback(json) {
		        if (!json.Error) {
		           console.log('Json Data from endpoint: ' , json );
		        }
		        else {
		            alert("Json callback: " + json.Message);
		        }
		    }//end Jsonp Callback


		function rand(start, end)
		{
			return Math.floor(Math.random() * end) + start;
		}

		    // onClick I want something exciting to happen

		$( "#wally" ).click(function() {

				var clicks = parseInt($('.clicks').text());

				clicks = clicks + 1;

  				var updateObj = { 
  									_id : $('.id').text(), 
  									adId:  $('.adId').text(),
  									channel: $('.location').text(), 
  									location: $(".location").text(), 
  									type: $(".type").text(), 
  									views: clicks
  								}

  					$.ajax({
					    url : "http://localhost:8081/load",
					    type: "POST",
					    data : updateObj,
					    dataType: 'json',
					    success: function(data, textStatus, jqXHR)
					    {
					        console.log("POST succeded: " , textStatus + "jqXHR: " ,  jqXHR );
					    },
					    error: function (jqXHR, textStatus, errorThrown)
					    {
					 		console.log("POST failed: " + errorThrown + " textStatus: " + textStatus );
					    }
					});//end ajax post 

				});//end of click

 	});// end document read 
</script>
<noscript>
	<h3>Sorry...you need javascript</h3>
</noscript>
</html>

