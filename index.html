<!DOCTYPE html PUBLIC "-//WC3//DTD XHTML 1.0 Strict//EN"

	http://www.w3.org/TR/xhmtl1/DTS/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">

	<head>
		<title>MEAN Server</title>

		  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

		  <meta name="viewport" content="width=device-width, initial-scale=1">

		  <style>
		  	#viddy {
		  		/* background: pink; */
		  	}
		  	#wally {
		  		cursor: pointer;
		  	}
		  </style>
	</head>
	<body> 
	<div id="viddy">
		<h3>Local Ad of the Day - REMOTE</h3>

		<video id="wally" width="320" height="240" autoplay><source id="thesource" src="" type="video/mp4"></video><br/>
		ID: <span class="id">Time to Chime</span><br/>
		Campaign Id: <span class="campaignId">campaign id</span><br/>
		Description: <span class="description">general description</span><br/>
		Country: <span class="country">country</span><br/>
		Type: <span class="type">type</span><br/>
		Launch: <span class="launch">launch date</span><br/>
		End Date: <span class="end">end date</span><br/>
		Image: <span class="image">image</span><br/>
		Video: <span class="video">video</span><br/>
		Clicks: <span class="clicks">clicks</span>
	</div>

</body>
<script>
 $(document).ready(function () {
 	var viddy;
	var id;
	var campaignId;
	var country;
	var description;
	var launch;
	var end;
	var image;
	var clicks;

				$.ajax({
				        type: 'GET',
				        //url: 'http://localhost:8081/test?callback=jsonpCallback',
				        //url: 'http://adserver-env-poly.elasticbeanstalk.com/?callback=jsonpCallback',
				        //url: 'http://localhost:8081/campaign/?callback=jsonpCallback',
				        url: 'http://nodejs-campaigner.rhcloud.com/campaign?callback=jsonpCallback',
				        crossDomain: true,
				        async: false,
				        jsonpCallback: 'jsonpCallback',
				        dataType: 'json',
				        contentType:'application/json',
				        error: function(data){
				        	console.log("error: " , data);
				        },
				        success: function(data) {  

				        	console.log("received new data: " , data ); 

				        	var r = rand( 0, data.length);
				        	console.log("random #:" + r );

				        	id = data[r]._id
				        	channels = data[0];
				        	ads = data[1];     
	
					        viddy = data[r].video; //ads.location;
					        campaignid = data[r].campaignId;
					        country = data[r].country;
					        description = data[r].description;
					        launch = data[r].launch;
					        end = data[r].end;
					        image = data[r].image;
					        video = data[r].video;
					        clicks = data[r].clicks;

					        console.log("Our Viddy: " + viddy );

						    $('#thesource').attr('src',viddy );

						    var player = document.getElementById('wally'); 

						    player.load(); 

						$(".id").text(id);
						$(".campaignId").text(campaignid);
						$(".country").text(country);
						$(".description").text(description);
						$(".launch").text(launch);
						$(".end").text(end);
						$(".image").text(image);
						$(".video").text(viddy);
						$(".clicks").text(clicks);
				        }
				    });


		 function jsonpCallback(json) {
		        if (!json.Error) {
		           console.log('Json Data from endpoint: ' , json );
		        }
		        else {
		            alert("Json callback: " + json.Message);
		        }
		    }//end Jsonp Callback


		function rand(start, end)
		{
			return Math.floor(Math.random() * end) + start;
		}

		    // onClick I want something exciting to happen

		$( "#wally" ).click(function() {

				var clicks = parseInt($('.clicks').text());

				clicks = clicks + 1;

  				var updateObj = { 
  									_id : $('.id').text(), 
  									campaignId:  $('.campaignId').text(),
  									country: $('.country').text(), 
  									description: $(".description").text(), 
  									launch: $(".launch").text(),
  									end: $(".end").text(),
  									image: $(".image").text(),
  									video: $(".video").text(), 
  									clicks: clicks
  								}

  					$.ajax({
					    url : "http://localhost:8081/load",
					     //url: 'http://adserver-env-poly.elasticbeanstalk.com/?callback=jsonpCallback',
					    type: "POST",
					    data : updateObj,
					    dataType: 'json',
					    success: function(data, textStatus, jqXHR)
					    {
					        console.log("POST succeded: " , textStatus + " jqXHR: " ,  jqXHR );
					    },
					    error: function (jqXHR, textStatus, errorThrown)
					    {
					 		console.log("POST failed: " + errorThrown + " textStatus: " + textStatus );
					    }
					});//end ajax post 

				});//end of click

		$('#wally').click( function () {
			sendmail = require('http://localhost:8888/sendmail/sendmail')();

			sendmail({
			    from: 'test@yourdomain.com',
			    to: 'cooperatkmba@gmail.com',
			    subject: 'test sendmail',
			    content: 'These are the times to try mens souls... ',
			  }, function(err, reply) {
			    console.log("Warning, Will Robinson!!! " + err && err.stack);
			    console.dir(reply);
			});
		});

 	});// end document ready
</script>
<noscript>
	<h3>Sorry...you need javascript</h3>
</noscript>
</html>

